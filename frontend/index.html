<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Boston Restaurant Inspections Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f5f5f5; }
        .header { background-color: #2c3e50; color: white; padding: 1rem 2rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .header h1 { font-size: 1.5rem; font-weight: 600; }
        .header .subtitle { font-size: 0.875rem; color: #bdc3c7; margin-top: 0.25rem; }
        .container { max-width: 1400px; margin: 0 auto; padding: 1.5rem; }
        .filters { background: white; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .filter-group { display: flex; flex-direction: column; }
        .filter-group label { font-size: 0.875rem; font-weight: 500; color: #555; margin-bottom: 0.5rem; }
        .filter-group select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.875rem; }
        .stats-bar { display: flex; gap: 2rem; padding-top: 1rem; border-top: 1px solid #eee; font-size: 0.875rem; flex-wrap: wrap; }
        .stat-value { font-size: 1.25rem; font-weight: 600; color: #2c3e50; }
        .stat-label { color: #999; font-size: 0.75rem; text-transform: uppercase; }
        #map { height: 600px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 1rem; }
        .loading { text-align: center; padding: 2rem; color: #666; }
        .legend { background: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; gap: 2rem; align-items: center; flex-wrap: wrap; }
        .legend-title { font-size: 0.875rem; font-weight: 600; color: #2c3e50; }
        .legend-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #555; }
        .legend-marker { width: 12px; height: 12px; border-radius: 50%; }
        .glossary-btn { margin-left: auto; padding: 0.4rem 0.8rem; background-color: #3498db; color: white; border: none; border-radius: 4px; font-size: 0.8rem; cursor: pointer; transition: background-color 0.2s; }
        .glossary-btn:hover { background-color: #2980b9; }
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 2rem; border-radius: 8px; max-width: 700px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-title { font-size: 1.5rem; font-weight: 600; color: #2c3e50; }
        .close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: #999; line-height: 1; }
        .close-btn:hover { color: #333; }
        .glossary-item { margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #eee; }
        .glossary-item:last-child { border-bottom: none; }
        .glossary-term { font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem; }
        .glossary-desc { color: #555; line-height: 1.6; }
        .inspection-popup { max-width: 320px; line-height: 1.6; }
        .inspection-popup strong { font-size: 0.875rem; color: #2c3e50; display: block; margin-top: 0.5rem; }
        .inspection-popup strong:first-child { margin-top: 0; }
        .inspection-popup .business-name { font-size: 1rem; font-weight: 700; color: #2c3e50; margin-bottom: 0.5rem; }
        .inspection-popup .result-badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-top: 0.5rem; }
        .result-pass { background-color: #27ae60; color: white; }
        .result-fail { background-color: #e74c3c; color: white; }
        .result-warning { background-color: #f39c12; color: white; }
        .leaflet-popup-content { max-height: 400px; overflow-y: auto; }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .filters-grid { grid-template-columns: 1fr; }
            .stats-bar { flex-direction: column; gap: 1rem; }
            #map { height: 500px; }
            .inspection-popup { max-width: 250px; font-size: 0.8rem; }
            .legend { flex-direction: column; align-items: flex-start; gap: 0.75rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Boston Restaurant Inspections Dashboard</h1>
        <div class="subtitle">Real-time tracking of food establishment health inspections across Boston</div>
    </div>
    <div class="container">
        <div class="filters">
            <div class="filters-grid">
                <div class="filter-group"><label for="zip-filter">ZIP Code</label><select id="zip-filter"><option value="">All ZIP Codes</option></select></div>
                <div class="filter-group"><label for="result-filter">Inspection Result</label><select id="result-filter"><option value="">All Results</option></select></div>
                <div class="filter-group"><label for="days-filter">Time Period</label><select id="days-filter"><option value="3">Last 3 Days</option><option value="7">Last 7 Days</option><option value="30">Last 30 Days</option><option value="60">Last 60 Days</option><option value="90" selected>Last 90 Days</option><option value="180">Last 6 Months</option><option value="365">Last Year</option><option value="730">Last 2 Years</option></select></div>
            </div>
            <div class="stats-bar">
                <div class="stat"><div class="stat-value" id="total-establishments">-</div><div class="stat-label">Establishments</div></div>
                <div class="stat"><div class="stat-value" id="pass-rate">-</div><div class="stat-label">Pass Rate</div></div>
                <div class="stat"><div class="stat-value" id="total-violations">-</div><div class="stat-label">Violations</div></div>
                <div class="stat"><div class="stat-value" id="last-sync">-</div><div class="stat-label">Last Updated</div></div>
            </div>
        </div>
        <div id="map"></div>
        <div class="loading" id="loading">Loading inspection data...</div>
        <div class="legend">
            <span class="legend-title">Map Legend:</span>
            <div class="legend-item"><span class="legend-marker" style="background-color: #27ae60;"></span><span>Pass</span></div>
            <div class="legend-item"><span class="legend-marker" style="background-color: #e74c3c;"></span><span>Fail</span></div>
            <div class="legend-item"><span class="legend-marker" style="background-color: #f39c12;"></span><span>Warning / Conditional</span></div>
            <div class="legend-item"><span class="legend-marker" style="background-color: #95a5a6;"></span><span>Other / Unknown</span></div>
            <button class="glossary-btn" onclick="openGlossary()">üìñ Violation Glossary</button>
        </div>
    </div>

    <!-- Glossary Modal -->
    <div id="glossaryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Violation Glossary</h2>
                <button class="close-btn" onclick="closeGlossary()">&times;</button>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Clean-up of Vomiting and Diarrheal Events (Pf)</div>
                <div class="glossary-desc">Restaurant must have written procedures for handling vomit or diarrhea incidents. This is a Priority Foundation violation‚Äîprocedures must minimize contamination spread and protect employees, customers, and food surfaces from exposure.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Food Contact Surfaces Clean</div>
                <div class="glossary-desc">All surfaces that touch food (cutting boards, utensils, equipment) must be properly cleaned and sanitized. Food debris or residue on these surfaces can lead to cross-contamination.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Hair Restraint / Clean Cloths</div>
                <div class="glossary-desc">Food handlers must wear effective hair restraints (hats, hairnets, beard nets) to prevent hair from contacting food, clean equipment, or utensils. Improper hair restraints can lead to food contamination.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Food Protection</div>
                <div class="glossary-desc">Food must be protected from contamination during storage, preparation, and service. This includes proper covering, temperature control, and preventing cross-contamination between raw and cooked foods.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Wiping Cloths Clean & Sanitize</div>
                <div class="glossary-desc">Wet wiping cloths must be stored in sanitizer solution when not in use. Leaving wet cloths on countertops allows bacteria to grow and spread contamination.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Hand Washing Facilities</div>
                <div class="glossary-desc">Handwashing sinks must be properly located, stocked with soap and paper towels, and accessible at all times. These sinks cannot be used for food prep or other purposes.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">PIC Performing Duties</div>
                <div class="glossary-desc">Person in Charge (PIC) must be present and actively monitoring food safety. The PIC is responsible for ensuring all food safety procedures are followed, including proper allergen information for customers.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Temperature Control</div>
                <div class="glossary-desc">Cold foods must be kept at 41¬∞F or below; hot foods at 135¬∞F or above. Improper temperatures allow dangerous bacteria to grow rapidly, increasing foodborne illness risk.</div>
            </div>
            <div class="glossary-item">
                <div class="glossary-term">Pest Control</div>
                <div class="glossary-desc">Establishment must have effective pest control measures to prevent insects, rodents, and other animals from contaminating food, equipment, and facilities.</div>
            </div>
            <div class="glossary-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 2px solid #eee;">
                <h3 style="font-size: 1rem; font-weight: 600; color: #2c3e50; margin-bottom: 0.5rem;">Violation Severity Levels</h3>
                <div class="glossary-desc">
                    <strong>‚ö†Ô∏è Minor (*)</strong> - Non-critical violations (-2 points): Sanitation issues not directly related to food safety<br><br>
                    <strong>‚ö†Ô∏è‚ö†Ô∏è Moderate (**)</strong> - Critical violations (-7 points): Issues that could contribute to food contamination<br><br>
                    <strong>‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Critical (***)</strong> - Foodborne illness risk factors (-10 points): Highest health risk violations
                </div>
            </div>
            <div class="glossary-section" style="margin-top: 1rem;">
                <div class="glossary-desc" style="font-size: 0.85rem; color: #777;">
                    Based on FDA Food Code and Massachusetts State Sanitary Code. For complete regulations, visit <a href="https://www.boston.gov/departments/inspectional-services" target="_blank" style="color: #3498db;">Boston Inspectional Services</a>.
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
const map=L.map('map').setView([42.3601,-71.0589],12);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
const markers=L.markerClusterGroup({maxClusterRadius:50});map.addLayer(markers);

function fmtDate(d){return d?new Date(d).toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'}):'N/A';}

function fmtSeverity(level){
  if(!level) return 'N/A';
  const stars = level.trim();
  if(stars === '*') return '‚ö†Ô∏è Minor';
  if(stars === '**') return '‚ö†Ô∏è‚ö†Ô∏è Moderate';
  if(stars === '***') return '‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è Critical';
  return level;
}

// Color-coded marker icons
const greenIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});
const redIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});
const yellowIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});
const greyIcon = L.icon({iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-grey.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]});

function getMarkerIcon(result){
  if(result==='Pass') return greenIcon;
  if(result==='Fail') return redIcon;
  if(result && (result.includes('Warning') || result.includes('HE_Fail'))) return yellowIcon;
  return greyIcon;
}

function getResultClass(result){
  if(result==='Pass') return 'result-pass';
  if(result==='Fail') return 'result-fail';
  return 'result-warning';
}

function popup(i){
  let html=`<div class="inspection-popup">`;
  html+=`<div class="business-name">${i.businessname||'Unknown Business'}</div>`;
  if(i.address) html+=`<div>${i.address}</div>`;
  if(i.dbaname && i.dbaname !== i.businessname) html+=`<strong>DBA:</strong> ${i.dbaname}<br>`;
  if(i.result) html+=`<span class="result-badge ${getResultClass(i.result)}">${i.result}</span><br>`;
  html+=`<strong>Inspected:</strong> ${fmtDate(i.resultdttm)}<br>`;
  if(i.licensecat) html+=`<strong>Type:</strong> ${i.licensecat}<br>`;
  if(i.licenseno) html+=`<strong>License:</strong> ${i.licenseno}<br>`;
  if(i.licstatus) html+=`<strong>Status:</strong> ${i.licstatus}<br>`;
  if(i.violdesc) html+=`<strong>Recent Violation:</strong> ${i.violdesc}<br>`;
  if(i.viol_level) html+=`<strong>Severity:</strong> ${fmtSeverity(i.viol_level)}<br>`;
  html+=`</div>`;
  return html;
}

// ZIP code center coordinates for Boston area
const zipCenters = {
  '02108': [42.3571, -71.0612], '02109': [42.3651, -71.0536], '02110': [42.3558, -71.0521],
  '02111': [42.3503, -71.0621], '02113': [42.3647, -71.0542], '02114': [42.3613, -71.0685],
  '02115': [42.3421, -71.0931], '02116': [42.3503, -71.0812], '02118': [42.3385, -71.0732],
  '02119': [42.3243, -71.0862], '02120': [42.3299, -71.0995], '02121': [42.3067, -71.0843],
  '02122': [42.2811, -71.0497], '02124': [42.2846, -71.0710], '02125': [42.3165, -71.0636],
  '02126': [42.2747, -71.1189], '02127': [42.3334, -71.0417], '02128': [42.3652, -71.0151],
  '02129': [42.3782, -71.0602], '02130': [42.3099, -71.1150], '02131': [42.2837, -71.1265],
  '02132': [42.2797, -71.1560], '02134': [42.3553, -71.1392], '02135': [42.3495, -71.1559],
  '02136': [42.2546, -71.1292], '02163': [42.3495, -71.1434], '02199': [42.3476, -71.0825],
  '02203': [42.3601, -71.0589], '02210': [42.3486, -71.0420], '02215': [42.3478, -71.1026]
};

function addMarkers(inspections){
  markers.clearLayers();
  inspections.forEach(i=>{
    if(i.latitude&&i.longitude){
      const m=L.marker([i.latitude,i.longitude],{icon:getMarkerIcon(i.result)});
      m.bindPopup(popup(i));
      markers.addLayer(m);
    }
  });
  document.getElementById('loading').style.display='none';
}

function zoomToZip(zip){
  if(zip && zipCenters[zip]){
    map.setView(zipCenters[zip], 14, {animate: true, duration: 0.8});
  } else {
    map.setView([42.3601, -71.0589], 12, {animate: true, duration: 0.8});
  }
}

async function load(){
  const z=document.getElementById('zip-filter').value;
  const r=document.getElementById('result-filter').value;
  const d=document.getElementById('days-filter').value;
  const p=new URLSearchParams({days:d,limit:2000});
  if(z)p.append('zip',z);
  if(r)p.append('result',r);
  document.getElementById('loading').style.display='block';
  try{
    const res=await fetch(`/api/inspections?${p}`);
    const data=await res.json();
    addMarkers(data.data);
    zoomToZip(z);
    document.getElementById('total-establishments').textContent=data.total.toLocaleString();
  }catch(e){
    console.error(e);
    document.getElementById('loading').textContent='Error loading data';
  }
}

async function loadStats(){
  const d=document.getElementById('days-filter').value;
  try{
    const res=await fetch(`/api/stats?days=${d}`);
    const data=await res.json();
    document.getElementById('pass-rate').textContent=`${data.pass_rate}%`;
    document.getElementById('total-violations').textContent=data.total_violations.toLocaleString();
  }catch(e){
    console.error(e);
  }
}

async function loadHealth(){
  try{
    const res=await fetch('/api/health');
    const d=await res.json();
    if(d.last_sync){
      const h=Math.round(d.hours_since_sync);
      document.getElementById('last-sync').textContent=h===0?'Just now':`${h}h ago`;
    }
  }catch(e){
    console.error(e);
  }
}

async function loadFilters(){
  try{
    const res=await fetch('/api/neighborhoods');
    const d=await res.json();
    const sel=document.getElementById('zip-filter');
    d.data.forEach(i=>{
      const o=document.createElement('option');
      o.value=i.zip;
      o.textContent=`${i.zip} (${i.count})`;
      sel.appendChild(o);
    });
  }catch(e){
    console.error(e);
  }
  try{
    const res=await fetch('/api/results');
    const d=await res.json();
    const sel=document.getElementById('result-filter');
    d.data.forEach(i=>{
      const o=document.createElement('option');
      o.value=i.code;
      o.textContent=i.label;
      sel.appendChild(o);
    });
  }catch(e){
    console.error(e);
  }
}

document.getElementById('zip-filter').addEventListener('change',()=>{load();loadStats();});
document.getElementById('result-filter').addEventListener('change',()=>{load();loadStats();});
document.getElementById('days-filter').addEventListener('change',()=>{load();loadStats();});

(async()=>{await loadFilters();await load();await loadStats();await loadHealth();})();

function openGlossary(){
  document.getElementById('glossaryModal').style.display='block';
}

function closeGlossary(){
  document.getElementById('glossaryModal').style.display='none';
}

// Close modal when clicking outside of it
window.onclick=function(e){
  const modal=document.getElementById('glossaryModal');
  if(e.target===modal){
    closeGlossary();
  }
}
    </script>
</body>
</html>
